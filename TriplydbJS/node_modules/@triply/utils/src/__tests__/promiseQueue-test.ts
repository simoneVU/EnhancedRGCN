//external dependencies
import wait from "../wait";
import chai from "chai";
import chaiAsPromised from "chai-as-promised";
chai.use(chaiAsPromised);
const expect = chai.expect;

import promiseQueue from "../promiseQueue";

describe("Promise Queue", function () {
  it("On empty queue", async function () {
    await promiseQueue([], { concurrent: 2 });
  });
  it("Queue where size is less than concurrency", async function () {
    await promiseQueue(
      [
        async () => {
          await wait(10);
        },
        async () => {
          await wait(10);
        },
      ],
      { concurrent: 4 }
    );
  });
  it("Queue where size is larger than concurrency", async function () {
    const result = await promiseQueue(
      [
        async () => {
          await wait(10);
        },
        async () => {
          await wait(10);
        },
      ],
      { concurrent: 1 }
    );
    expect(result).to.have.lengthOf(2);
  });
  it("Queue where one fails", async function () {
    await expect(
      promiseQueue(
        [
          async () => {
            await wait(10);
          },
          async () => {
            await wait(10);
          },
          async () => {
            throw new Error("something");
          },
        ],
        { concurrent: 2 }
      )
    ).eventually.rejectedWith("something");
  });
});
