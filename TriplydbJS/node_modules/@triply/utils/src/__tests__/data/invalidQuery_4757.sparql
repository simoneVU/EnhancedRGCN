prefix table: <https://www.rijksfinancien.nl/informatieproducten/id/tabel/RBV1.24/>
 prefix tablehead: <https://www.rijksfinancien.nl/informatieproducten/id/tabelkop/RBV1.24/a/>
 prefix row: <https://www.rijksfinancien.nl/informatieproducten/id/rij/RBV1.24/a/>
 prefix dsd: <https://www.rijksfinancien.nl/informatieproducten/id/dsd/1.24->
 PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
 PREFIX sdo: <https://schema.org/>
 PREFIX ffact: <https://www.rijksfinancien.nl/financieelfeit/>
 PREFIX fbud: <https://www.rijksfinancien.nl/rijksbegroting/>
 PREFIX fstr: <https://www.rijksfinancien.nl/rijksbegrotingsstructuur/>
 PREFIX qb: <http://purl.org/linked-data/cube#>
 PREFIX rij: <https://www.rijksfinancien.nl/informatieproducten/id/rij/>
 PREFIX dct: <http://purl.org/dc/terms/>
 PREFIX pres: <https://www.rijksfinancien.nl/informatieproducten/def/>
 PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
 PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
 prefix ui: <http://www.w3.org/ns/ui#>
 prefix ns: <http://ns.nature.com/terms/>
 prefix time: <http://www.w3.org/2006/time#/>
 SELECT * WHERE {
   # TABLE SPECIFIC INFO
   ?chapter fstr:hasBudgetStructureElementName ?ministry ;
            fstr:hasBudgetStructureElementNumber ?chapterNumber ;
            fstr:hasBudgetChapterRomanNumber ?romanNumeral ;
            fstr:hasActiveBudgetStructurePeriod/time:hasDateTimeDescription/time:year ?year .

   ?hasBudgetMemorandumPeriod time:hasDateTimeDescription/time:year ?year .

   # Tabel styling
   table:a ui:style ?style .hasBudgetMemorandumPeriodhasBudgetMemorandumPeriod
   table:a pres:template ?widget ;
           dct:hasPart
       [ ns:number 1 ;
         pres:template ?row1 ] ,
       [ ns:number 2 ;
         pres:template ?row2 ] ,
       [ ns:number 4 ;
         pres:template ?row4 ] ,
       [ ns:number 5 ;
         pres:template ?row5 ] ,
       [ ns:number 7 ;
         pres:template ?row7 ] .
   {
     ## DATA
     {
       SELECT
       (replace(str(SUM(coalesce(?incoming,0))),'[0-9](?=(?:[0-9]{3})+(?![0-9]))','$0.') as ?incomingSum) \t\t\t
       (replace(str(SUM(coalesce(?outgoing,0))),'[0-9](?=(?:[0-9]{3})+(?![0-9]))','$0.') as ?outgoingSum)\t
       (replace(str(SUM(coalesce(?commitment,0))),'[0-9](?=(?:[0-9]{3})+(?![0-9]))','$0.') as ?commitmentSum)
       WHERE {
         ?observation qb:dataSet [ fbud:hasBudgetMemorandumPeriod ?hasBudgetMemorandumPeriod ;
                                   fbud:referencesBudgetStructureElement ?chapter ;
                                   qb:structure dsd:a] .
         {
           ?observation fbud:hasTransactionalDirection fbud:Incoming ;
                        ffact:hasMonetaryAmount/sdo:value ?incoming .
         } UNION {
           ?observation  fbud:hasTransactionalDirection fbud:Outgoing ;
                         fbud:hasTransactionalRealisationPhase fbud:CashFlow ;
                         ffact:hasMonetaryAmount/sdo:value ?outgoing .
         } UNION {
           ?observation fbud:hasTransactionalDirection fbud:Outgoing ;
                        fbud:hasTransactionalRealisationPhase fbud:Commitment ;
                        ffact:hasMonetaryAmount/sdo:value ?commitment .
         }
       }
     }
     ## HTML
     row:3 pres:beginRow ?beginRow ;
           pres:beginText ?beginText ;
           pres:endText ?endText ;
           pres:endRow ?endRow .
     BIND(concat(str(?beginText),?commitmentSum,str(?endText)) as ?CommitmentValues)
     BIND(concat(str(?beginText),?outgoingSum,str(?endText)) as ?OutgoingValues)
     BIND(concat(str(?beginText),?incomingSum,str(?endText)) as ?IncomingValues)
     BIND(concat(str(?beginRow),?CommitmentValues,?OutgoingValues,?IncomingValues,str(?endRow)) as ?row3)
   }
   {
     SELECT (GROUP_CONCAT(?row ;
         separator="") as ?row6) WHERE {
       {
         SELECT ?ArticleNum ?row WHERE {
           ## DATA
           {
             SELECT ?Descrip ?ArticleNum (SUM(coalesce(?incoming,0)) as ?incoming) (SUM(coalesce(?outgoing,0)) as ?outgoing) (SUM(coalesce(?commitment,0)) as ?commitment) WHERE {
               ?observation fbud:referencesBudgetStructureElement
                   [fstr:hasBudgetStructureElementName ?Descrip ;
                    fstr:hasBudgetStructureElementNumber ?ArticleNum ] ;
                    qb:dataSet
                   [ fbud:hasBudgetMemorandumPeriod ?hasBudgetMemorandumPeriod ;
                     fbud:referencesBudgetStructureElement ?chapter;
                     qb:structure dsd:a ] .
               {
                 ?observation fbud:hasTransactionalDirection fbud:Incoming ;
                              ffact:hasMonetaryAmount/sdo:value ?incoming .
               } UNION
               {
                 ?observation  fbud:hasTransactionalDirection fbud:Outgoing ;
                               fbud:hasTransactionalRealisationPhase fbud:CashFlow ;
                               ffact:hasMonetaryAmount/sdo:value ?outgoing  .
               } UNION
               {
                 ?observation fbud:hasTransactionalDirection fbud:Outgoing ;
                              fbud:hasTransactionalRealisationPhase fbud:Commitment ;
                              ffact:hasMonetaryAmount/sdo:value ?commitment  .
               }
             }
           }
           ## HTML
           row:6 pres:beginRow ?beginRow;
                 pres:beginText ?beginText ;
                 pres:endText ?endText;
                 pres:endRow ?endRow .
           BIND(concat(str(?beginText),?ArticleNum,str(?endText)) as ?ArticleNumber)
           BIND(concat(str(?beginText),?Descrip,str(?endText)) as ?Description)
           BIND(concat(str(?beginText),replace(?commitment,'[0-9](?=(?:[0-9]{3})+(?![0-9]))','$0.'),str(?endText)) as ?CommitmentValues)
           BIND(concat(str(?beginText),replace(?outgoing,'[0-9](?=(?:[0-9]{3})+(?![0-9]))','$0.'),str(?endText)) as ?OutgoingValues)
           BIND(concat(str(?beginText),replace(?incoming,'[0-9](?=(?:[0-9]{3})+(?![0-9]))','$0.'),str(?endText)) as ?IncomingValues)
           BIND(concat(str(?beginRow),?ArticleNumber,?Description,?CommitmentValues,?OutgoingValues,?IncomingValues,str(?endRow)) as ?row)
         }
         ORDER BY xsd:integer(?ArticleNum)
       }
     }
   }
   {
     SELECT (GROUP_CONCAT(?subRows;
         separator="") as ?row8) WHERE {
       ## DATA
       ## HTML
       row:8 pres:beginRow ?beginRow;
             pres:beginText ?beginText ;
             pres:endText ?endText;
             pres:endRow ?endRow .
       BIND(concat(str(?beginText),str(""),str(?endText)) as ?ArticleNumber)
       BIND(concat(str(?beginText),str(""),str(?endText)) as ?Description)
       BIND(concat(str(?beginText),str(""),str(?endText)) as ?CommitmentValues)
       BIND(concat(str(?beginText),str(""),str(?endText)) as ?OutgoingValues)
       BIND(concat(str(?beginText),str(""),str(?endText)) as ?IncomingValues)
       BIND(concat(str(?beginRow),?ArticleNumber,?Description,?CommitmentValues,?OutgoingValues,?IncomingValues,str(?endRow)) as ?subRows)
     }
   }
 }
 limit 1
