prefix bag: <https://bag2.basisregistraties.overheid.nl/bag/def/>
prefix bif: <http://www.openlinksw.com/schemas/bif#>
prefix foaf: <http://xmlns.com/foaf/0.1/>
prefix geo: <http://www.opengis.net/ont/geosparql#>
prefix prov: <http://www.w3.org/ns/prov#>
prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#>
prefix skos: <http://www.w3.org/2004/02/skos/core#>
select distinct ?punt ?puntLabel ?vlak {
  {
    select distinct * {
      ?woonplaatsRegistratie foaf:primaryTopic ?woonplaats.
      filter not exists { ?woonplaatsRegistratie prov:invalidatedAtTime []. }
      ?openbareRuimteRegistratie
        bag:ligtIn ?woonplaats;
        foaf:primaryTopic ?openbareRuimte;
      filter not exists { ?openbareRuimteRegistratie prov:invalidatedAtTime []. }
      ?nummeraanduidingRegistratie
        bag:huisnummer ?huisnummer;
        bag:ligtAan ?openbareRuimte;
        bag:postcode ?postcode;
        foaf:primaryTopic ?nummeraanduiding.
      filter not exists { ?nummeraanduidingRegistratie prov:invalidatedAtTime []. }
      ?verblijfsobjectRegistratie
        bag:hoofdadres ?nummeraanduiding;
        bag:maaktDeelUitVan ?pand.
      filter not exists { ?verblijfsobjectRegistratie prov:invalidatedAtTime []. }
      ?pandRegistratie foaf:primaryTopic ?pand.
      filter not exists { ?pandRegistratie prov:invalidatedAtTime []. }
    }
    limit 250
  }
  ?woonplaatsRegistratie skos:prefLabel ?woonplaatsNaam.
  ?openbareRuimteRegistratie skos:prefLabel ?openbareRuimteNaam.
  optional { ?nummeraanduidingRegistratie bag:huisletter ?huisletter. }
  optional { ?nummeraanduidingRegistratie bag:huisnummertoevoeging ?huisnummertoevoeging. }
  ?verblijfsobjectRegistratie
    bag:geometrie ?puntRd;
    bag:oppervlakte ?oppervlakte;
    bag:status ?verblijfsobjectStatus.
  ?verblijfsobjectStatus skos:prefLabel ?verblijfsobjectStatusLabel.
  bind(bif:ST_Transform(strdt(replace(replace(str(?puntRd),"Z","")," 0([,)])","$1"),geo:wktLiteral), 4326) as ?punt)
  ?pandRegistratie
    bag:bouwjaar ?bouwjaar;
    bag:geometrie ?vlakRd;
    bag:status ?pandStatus.
  ?pandStatus skos:prefLabel ?pandStatusLabel.
  bind(bif:ST_Transform(strdt(replace(replace(str(?vlakRd),"Z","")," 0([,)])","$1"),geo:wktLiteral), 4326) as ?vlak)
  bind(strdt(concat(
"<h3><a href='",str(?openbareRuimteRegistratie),"' target='_blank'>",str(?openbareRuimteNaam),"</a> ",str(?huisnummer),
  if(bound(?huisletter),str(?huisletter),""),
  if(bound(?huisnummertoevoeging),concat("-",str(?huisnummertoevoeging)),""),", ",
  str(?postcode)," <a href='",str(?woonplaatsRegistratie),"' target='_blank'>",str(?woonplaatsNaam),"</a></h3>",
"<h4><a href='",str(?verblijfsobjectRegistratie),"' target='_blank'>Verblijfsobject</a></h4>",
"<dl>",
  "<dt>Oppervlakte</dt><dd>",replace(str(?oppervlakte),"[0-9](?=(?:[0-9]{3})+(?![0-9]))","$0.")," mÂ²</dd>",
  "<dt>Status</dt><dd><a href='",str(?verblijfsobjectStatus),"' target='_blank'>",str(?verblijfsobjectStatusLabel),"</a></dd>",
"</dl>",
"<h4><a href='",str(?pandRegistratie),"' target='_blank'>Pand</a></h4>",
"<dl>",
  "<dt>Bouwjaar</dt><dd>",str(?bouwjaar),"</dd>",
  "<dt>Status</dt><dd><a href='",str(?pandStatus),"' target='_blank'>",str(?pandStatusLabel),"</a></dd>",
"</dl>"),rdf:HTML) as ?puntLabel)
}