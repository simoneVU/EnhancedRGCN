#!/usr/bin/env node
import { isSemver } from "../calver";

const newVersion = process.env["npm_package_version"];
if (!newVersion) {
  console.error(
    "Only run this script via `yarn run` or `yarn exec`. Otherwise, we do not have access to the npm_package_version env variable"
  );
  process.exit(1);
}

const parentNpmCmd = process.env["npm_config_argv"];
if (!parentNpmCmd) {
  console.error(
    "Only run this script via `yarn run` or `yarn exec`. Otherwise, we do not have access to the npm_config_argv env variable"
  );
  process.exit(1);
}
const parsedParentNpmCmd = JSON.parse(parentNpmCmd);
const [npmSubCmd] = parsedParentNpmCmd.original;
if (npmSubCmd === "version" && parsedParentNpmCmd.original.indexOf("--new-version") < 0) {
  console.error(
    `Expected ${process.env["npm_package_version"]} to be calver. It seems to be semver though, considering you're running this with an 'yarn version' command`
  );
  process.exit(1);
}

if (isSemver(newVersion)) {
  console.error(
    `Expected ${process.env["npm_package_version"]} to be calver. It seems to be semver though. Did you run 'yarn version --patch' or something?`
  );
  process.exit(1);
}
process.exit(0);
