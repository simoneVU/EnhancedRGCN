import { merge, set, map, camelCase, startsWith, size } from "lodash";

export function getEnvironmentVarsAsObject(envPrefix: string) {
  if (!process.env || size(process.env) === 0) {
    /* eslint-disable */
    console.trace(
      "WARNING: No environment variables set, running config generation on client? Config cannot be overwritten by env"
    );
    return;
  }
  var autocast = require("autocast");
  var values = {};
  for (var envKey in process.env) {
    //should we store this env var in the config:
    if (startsWith(envKey, envPrefix)) {
      //simply casting. So far, not using vals such as dates that might get misinterpreted
      var val: any = autocast(process.env[envKey]);
      envKey = envKey.substring(envPrefix.length);
      //read env variables, and store in config. E.g. TRIPLY__MAIL__REPLY_TO = 'bla'
      //i.e., splits by __, changes to camelcase, and set in config
      set(values, map(envKey.split("__"), camelCase), val);
    }
  }
  return values;
}

abstract class Config {
  protected envVarPrefix = "TRIPLY__";
  isDevelopment = process.env.NODE_ENV !== "production";
  constructor(envVarPrefix?: string) {
    if (envVarPrefix) this.envVarPrefix = envVarPrefix;
    this.validateEnvVariables();

    //set before other defaults, as some values may inherit from others
    this.setFromEnvironment();

    this.setDefaults();

    //also set from env after defaults, to overwrite them
    this.setFromEnvironment();

    this.postProcess();
  }
  abstract validateEnvVariables(): void;
  abstract setDefaults(): void;
  abstract postProcess(): void;
  setFromEnvironment() {
    merge(this, getEnvironmentVarsAsObject(this.envVarPrefix));
  }
}
export default Config;
